---
title: "GLMM_ASCA_balanced_poisson"
author: "Auke Haver"
date: "4/13/2021"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r echo=FALSE}
library("lme4")
library("tidyverse")
library("kableExtra")
library("ggpubr")
library("vegan")
source("../R/PEM-SCA_supplementary_functions.R",local=TRUE)
```

# Introduction
In this simulation, we will apply the ASCA framework on unbalanced, Poisson-distributed data. Furthermore, we will consider repeated measurements on unbalanced groups. This will require the use of Generalized Linear Mixed Models for estimating effect matrices, which can be decomposed into scores and loadings through Singular Value Decomposition. We will utilize a Jack-knife approach for validation of our method. 

```{r}
# design size
n_treatments = 5
n_timepoints = 3
timepoints = c("0","6","12") %>% factor(x=.,levels=.)
treatments = c("1","2","3","4","5")%>% factor(x=.,levels=.)
n_PC = 2 
n_variables = 8
n_subjects = 208
n_replicates = 60

# Design dataframe
design <- tibble(subject = seq(n_treatments*n_replicates) %>% 
                         rep(n_timepoints) %>% 
                         factor(),
                       timepoint = seq(1:n_timepoints)%>%
                         rep(each=n_treatments*n_replicates) %>% 
                         factor(),
                       treatment = seq(1:n_treatments) %>%
                         rep(each=n_replicates) %>%
                         rep(n_timepoints) %>%
                         factor())
contrasts(design$timepoint) <- contr.sum(n_timepoints)
contrasts(design$treatment) <- contr.sum(n_treatments)

# Fixed effect model matrix
X <- simulate_fixed_param_matrix(levels=c(n_timepoints,n_treatments),
                                 effects=c("A","AB"),
                                 replicates = n_replicates) %>%
  as_tibble()%>%
  setNames(c("mean",
             paste0("timepoint",
                           seq(1:2)),
             paste0("timepoint",
                    rep(seq(1:n_timepoints),each=n_treatments-1),
                    ":treatment",
                    rep(seq(1:(n_treatments-1)),n_timepoints)))) %>%
  relocate("mean",
           paste0("timepoint",
                           seq(1:2)),
           paste0("timepoint",
                    rep(seq(1:n_timepoints),n_treatments-1),
                    ":treatment",
                    rep(seq(1:(n_treatments-1)),each=n_timepoints))) %>%
  as.matrix()

# Random effect model matrix
Z <- contr.sum((n_treatments*n_replicates)+1)[1:(n_treatments*n_replicates),] %>%
  apply(FUN=function(x)rep(x,n_timepoints),MARGIN=2)

```

# Scores and Loadings
Having decided the design of the simulation, we will continue with setting the scores ($T$) and loadings ($P$) for the time ($\alpha$) and time-treatment interaction ($\alpha\beta$) effects, in order to create effect matrices. Whereas scores only need to be orthogonal within one effect matrix, all loadings are required to be orthonormal.

```{r}
# Scores
Ta <- c(-4,   0, 4,
        .1,-.2,.1) %>%
  rep(each = n_treatments*n_replicates) %>% 
  matrix(ncol=2) 

Tab<-c(.01,.02,-.01,-.02,0,3, 1, -.5,-1.5,-2,4,-.5,-1,-1.5,-1,
       -.15,-.05,-.15,-.05,0.305,.03,0,.04,.02,.02,-0.005,.03, -0.03 ,.01,-0.02)%>%
  rep(each = n_replicates)%>% 
  matrix(ncol=2) 


# Loadings
Pa <- c(.5,-.5,0,0,.5,-.5,0,0,
        .5,.5,0,0,-.5,-.5,0,0) %>% matrix(ncol=2) 
Pab<- c(0,0,.5,-.5,.5,-.5,0,0,
        0,0,.5,.5,-.5,-.5,0,0) %>% matrix(ncol=2) 

# Plot
T_df <- tibble(timepoint = rep(timepoints,
                               each=n_treatments*n_replicates),
               treatment = rep(treatments,
                               n_timepoints) %>% 
                 rep(each=n_replicates), 
               Ta_PC1 = Ta[,1],
               Ta_PC2 = Ta[,2],
               Tab_PC1 = Tab[,1],
               Tab_PC2 = Tab[,2])
P_df <- tibble(variable = LETTERS[1:8],
               Pa_PC1 = Pa[,1],
               Pa_PC2 = Pa[,2],
               Pab_PC1 = Pab[,1],
               Pab_PC2 = Pab[,2])


```

## Plot Scores
```{r}
ggarrange(T_df %>%
  ggplot(aes(x=timepoint,y=Ta_PC1))+
  geom_point() +
  labs(y="Time effect\nScores PC1",
       x="Time (months)")+
    theme(aspect.ratio=1)+
  theme_classic()+
    theme(aspect.ratio = 1),
  T_df %>%
  ggplot(aes(x=timepoint,y=Ta_PC2))+
  geom_point()+
  labs(y="Time effect\nScores PC2",
       x="Time (months)")+
    theme(aspect.ratio=1)+
  theme_classic()+
    theme(aspect.ratio = 1),
T_df %>%
  ggplot(aes(x=timepoint,y=Tab_PC1,color=treatment))+
  geom_point() +
    geom_line(aes(group=treatment))+
  labs(y="Time:Treatment effect\nScores PC1",
       x="Time (months)",
       color="Treatment Group")+
    theme(aspect.ratio=1)+
  theme_classic()+
    theme(aspect.ratio = 1),
  T_df %>%
  ggplot(aes(x=timepoint,y=Tab_PC2,color=treatment))+
  geom_point() +
    geom_line(aes(group=treatment))+
  labs(y="Scores PC2",
       x="Time:Treatment effect\nTime (months)",
       color="Treatment Group")+
    theme(aspect.ratio=1)+
  theme_classic()+
    theme(aspect.ratio = 1),
ncol=2,
nrow=2,
common.legend = TRUE,
legend="bottom")
```

## Plot Loadings
```{r}
ggarrange(
  P_df %>%
    ggplot(aes(x=variable,
               y=Pa_PC1))+
    geom_bar(stat="identity")+
    geom_abline(slope=0,intercept=0)+
    theme_classic()+
    theme(aspect.ratio = 1)+
    labs(y="Time effect\nLoadings PC1",
         x="Variable"),
  P_df %>%
    ggplot(aes(x=variable,
               y=Pa_PC2))+
    geom_bar(stat="identity")+
    geom_abline(slope=0,intercept=0)+
    theme_classic()+
    theme(aspect.ratio = 1)+
    labs(y="Time effect\nLoadings PC1",
         x="Variable"),
  P_df %>%
    ggplot(aes(x=variable,
               y=Pab_PC1))+
    geom_bar(stat="identity")+
    geom_abline(slope=0,intercept=0)+
    theme_classic()+
    theme(aspect.ratio = 1)+
    labs(y="Time:Treatment effect\nLoadings PC1",
         x="Variable"),
  P_df %>%
    ggplot(aes(x=variable,
               y=Pab_PC2))+
    geom_bar(stat="identity")+
    geom_abline(slope=0,intercept=0)+
    theme_classic()+
    theme(aspect.ratio = 1)+
    labs(y="Time:Treatment effect\nLoadings PC2",
         x="Variable"))
```
## Compose (Effect Matrices)
```{r}
# Means
M0  <- rep(5,n_treatments*n_replicates*n_timepoints*n_variables) %>% 
  matrix(ncol=n_variables)

# Time Effect
Ma <- Ta %*% t(Pa)

# Time-Treatment Interaction Effect
Mab <- Tab %*% t(Pab)

# Set seed
set.seed(1)

# Subject Effect
Ms <- vector(mode="numeric")
for(i in 1:(n_variables*n_timepoints*n_treatments)){
  Ms <- c(Ms,
          MASS::mvrnorm(n_replicates,
                        empirical = TRUE,
                        Sigma=.05,
                        mu=0))}
Ms <- matrix(Ms,ncol=n_variables)



```

# Modify balanced dataset to unbalanced, poisson dataset
```{r}
# set seed
set.seed(2)

# Combine matrices into dummy response variable
Y <- (M0+Ma+Mab+Ms) %>%                      # Combine matrices
  exp() %>% # Calculate exponential
  matrix(ncol=n_variables) %>%
  sapply(function(x){rpois(n=1,lambda=x)}) %>% # Generate poisson-data
  matrix(ncol=n_variables)                     # Re-format as matrix
colnames(Y)<- paste0("variable_",LETTERS[1:n_variables])

# Generate error matrix in link space
Me <- log(Y+1)-(M0+Ma+Mab+Ms)

# set seed for replication purposes
set.seed(3)

# Generate subset numbers
subset <- sample(n_replicates*n_treatments,
                n_subjects,
                replace=FALSE) %>% 
  sort()
subset_rows <- c(subset,
                 subset+(n_replicates*n_treatments),
                 subset+(n_replicates*n_treatments*2))

# Select only the 208 subsets
Y_sub <- Y[subset_rows,]
X_sub <- X[subset_rows,]
design_sub <- design[subset_rows,]
M0_sub <- M0[subset_rows,]
Ma_sub <- Ma[subset_rows,]
Mab_sub <- Mab[subset_rows,]
Me_sub <- Me[subset_rows,]
Ms_sub <- Ms[subset_rows,]

# Show overview of design
replicates <- design_sub %>% select(-timepoint)%>%
  distinct()%>%
  group_by(treatment)%>%
  summarize(replicates=n(),.groups="drop") 
  
```

# GLMM fitting without resampling
```{r}
coeff_est <- cbind(design_sub,Y_sub) %>%
    as_tibble()%>%
    pivot_longer(cols=paste0("variable_",LETTERS[1:n_variables]), 
                 names_to = "variable",
                 values_to = "value",
                 names_prefix="variable_")%>%
    group_by(variable)%>%
    group_nest() %>%
    # Fit GLMM
    mutate(model = map(data,
                     function(x)
                       glmer(value~timepoint+timepoint:treatment+(1|subject),
                             data=x,
                             family="poisson",
                             control=glmerControl(optimizer="bobyqa")))) %>%
    # Extract Fixed and Random effect coefficients and residuals
    mutate(fixed = map(model,
                     function(x) coef(x)$subject %>%
                       mutate(overal_mean = mean(`(Intercept)`))%>%
                       relocate(overal_mean)%>%
                       select(-`(Intercept)`) %>%
                       distinct()%>%
                       pivot_longer(cols=colnames(.),
                                    names_to = "parameter",
                                    values_to = "estimate")%>%
                       column_to_rownames("parameter")),
         random = map(model,
                      function(x) coef(x)$subject %>%
                        rownames_to_column(var="subject")%>%
                        mutate(offset = `(Intercept)`-mean(`(Intercept)`)) %>%
                        select(subject,offset)%>%
                       column_to_rownames("subject")),
         resids = map(model,
                      function(x) residuals(x) %>% 
                        as_tibble()%>%
                        mutate(measurement = paste0("measurement_",row_number()))%>%
                        column_to_rownames("measurement"))) %>%
  select(fixed,random,resids)
  # Make Ith fold fixed effect parameter matrix
  O_est <- 
    do.call("cbind",coeff_est$fixed) %>%
    set_names(colnames(Y_sub)) %>% as.matrix()


  # Rebuild effect Matrices
  M0_est <- as.matrix(X_sub[,1],ncol=1) %*% t(as.matrix(O_est[1,],ncol=1)) # Coercing matrix is required
  Ma_est <- X_sub[,2:3]%*%O_est[2:3,]
  Mab_est<- X_sub[,4:15]%*%O_est[4:15,]
  Mres_est<-do.call("cbind",coeff_est$resids)%>%
    set_names(colnames(Y_sub)) %>% 
    as.matrix()
  
  
  
  Msub_est<-do.call("cbind",coeff_est$random) %>%
    set_names(colnames(Y_sub)) %>%
    apply(FUN=function(x)rep(x,n_timepoints),MARGIN=2) %>%
    as.matrix()
  
  # Calculate explained variance per effect matrix
  ssq_est <- c(ssq(M0_est),
                ssq(Ma_est),
                ssq(Mab_est),
                ssq(Msub_est),
                ssq(Mres_est))
  perc_expl_est <- tibble(matrix = c("M0","Ma","Mab","Msub","Mres"),
                           perc_expl = ssq_est/sum(ssq_est))



  # Perform PCA on effect matrices
  Ma_pca <- perform_pca(Ma_est)
  Mab_pca<- perform_pca(Mab_est)
  Ta_est <- design_sub %>%
    cbind(Ma_pca$scores[,1:2] %>% round(5)) %>%
    select(-c(subject,treatment)) %>%
    distinct() %>%
    pivot_longer(cols=! timepoint,
                 names_to = "PC",
                 values_to = "score") 
   Tab_est<-design_sub %>%
    cbind(Mab_pca$scores[,1:2] %>% round(5)) %>%
    select(-c(subject)) %>%
    distinct() %>%
    pivot_longer(cols=! c(timepoint,treatment),
                 names_to = "PC",
                 values_to = "score")
  Pa_est<-tibble(variable = LETTERS[1:n_variables]) %>%
    cbind(Ma_pca$loadings[,1:2] %>% round(5)) %>%
    pivot_longer(cols=! variable,
                 names_to = "PC",
                 values_to = "loading")
  Pab_est<-tibble(variable = LETTERS[1:n_variables]) %>%
    cbind(Mab_pca$loadings[,1:2] %>% round(5)) %>%
    pivot_longer(cols=! variable,
                 names_to = "PC",
                 values_to = "loading")
  perc_expl_a <- round((Ma_pca$singular_values^2)*100/ssq(Ma_pca$singular_values),1)
  perc_expl_ab <- round((Mab_pca$singular_values^2)*100/ssq(Mab_pca$singular_values),1)
```


# GLMM fitting with 10-fold resampling
```{r}
n_folds=10

design_sub_resampling <-
  design_sub %>% 
  mutate(subgroup = generate_resampling_groups(replicates$replicates,n_folds)%>% rep(n_timepoints)) 

  # Make tibbles to 
  Ta_jackknife <- tibble(timepoint = rep(seq(1:n_timepoints),each=2),
                        PC = rep(c(1,2),n_timepoints))
  Tab_jackknife <- tibble(timepoint = rep(seq(1:n_timepoints),each=2*n_treatments),
                         treatment = rep(seq(1:n_treatments),each=2)%>% rep(n_timepoints),
                        PC = rep(c(1,2),n_timepoints*n_treatments))
  Pa_jackknife <- tibble(Variable = LETTERS[1:n_variables] %>% rep(each=2),
                         PC = rep(c(1,2),n_variables))
  Pab_jackknife <- tibble(Variable = LETTERS[1:n_variables] %>% rep(each=2),
                         PC = rep(c(1,2),n_variables))

  
  
  Mab_fold <- list()

for(i in 1:10){
  X_fold <- 
    cbind(design_sub_resampling,X_sub) %>%
    as_tibble()%>%
    filter(subgroup!=i) %>%
    select(-colnames(design_sub_resampling)) %>%
    as.matrix()
  subfold_coef <-cbind(design_sub_resampling,Y_sub) %>%
    as_tibble()%>%
    filter(subgroup!=i)%>%
    select(-subgroup)%>%
    pivot_longer(cols=paste0("variable_",LETTERS[1:n_variables]), 
                 names_to = "variable",
                 values_to = "value",
                 names_prefix="variable_")%>%
    group_by(variable)%>%
    group_nest() %>%
    # Fit GLMM
    mutate(model = map(data,
                     function(x)
                       glmer(value~timepoint+timepoint:treatment+(1|subject),
                             data=x,
                             family="poisson",
                             control=glmerControl(optimizer="bobyqa")))) %>%
    # Extract Fixed and Random effect coefficients and residuals
    mutate(fixed = map(model,
                     function(x) coef(x)$subject %>%
                       mutate(overal_mean = mean(`(Intercept)`))%>%
                       relocate(overal_mean)%>%
                       select(-`(Intercept)`) %>%
                       distinct()%>%
                       pivot_longer(cols=colnames(.),
                                    names_to = "parameter",
                                    values_to = "estimate")%>%
                       column_to_rownames("parameter")),
         random = map(model,
                      function(x) coef(x)$subject %>%
                        rownames_to_column(var="subject")%>%
                        mutate(offset = `(Intercept)`-mean(`(Intercept)`)) %>%
                        select(subject,offset)%>%
                       column_to_rownames("subject")),
         resids = map(model,
                      function(x) residuals(x) %>% 
                        as_tibble()%>%
                        mutate(measurement = paste0("measurement_",row_number()))%>%
                        column_to_rownames("measurement"))) %>%
  select(fixed,random,resids)
  # Make Ith fold fixed effect parameter matrix
  O_fold <- 
    do.call("cbind",subfold_coef$fixed) %>%
    set_names(colnames(Y_sub)) %>% as.matrix()
  
  # Rebuild effect Matrices
  M0_fold <- as.matrix(X_fold[,1],ncol=1) %*% t(as.matrix(O_fold[1,],ncol=1)) # Coercing matrix is required
  Ma_fold <- X_fold[,2:3]%*%O_fold[2:3,]
  Mab_fold[[i]]<- X_fold[,4:15]%*%O_fold[4:15,]
  Mres_fold<-do.call("cbind",subfold_coef$resids)%>%
    set_names(colnames(Y_sub)) %>% 
    as.matrix()
  Msub_fold<-do.call("cbind",subfold_coef$random) %>%
    set_names(colnames(Y_sub)) %>%
    apply(FUN=function(x)rep(x,n_timepoints),MARGIN=2) %>%
    as.matrix()
  
  # Calculate explained variance per effect matrix
  ssq_fold <- c(ssq(M0_fold),
                ssq(Ma_fold),
                ssq(Mab_fold[[i]]),
                ssq(Msub_fold),
                ssq(Mres_fold))
  perc_expl_fold <- tibble(matrix = c("M0","Ma","Mab","Msub","Mres"),
                           perc_expl = ssq_fold/sum(ssq_fold))
  

  
  # Perform PCA on effect matrices
  Ma_jackknife_pca <- perform_pca(Ma_fold)
  Mab_jackknife_pca<- perform_pca(Mab_fold[[i]])
  

      #### TEST START
  loadings_difference_1 <- abs(sum(unique_loadings(Mab_pca)[,1]+unique_loadings(Mab_jackknife_pca)[,1]))
  loadings_difference_2 <- abs(sum(unique_loadings(Mab_pca)[,1]-unique_loadings(Mab_jackknife_pca)[,1]))
    #  print(i)
     # print(loadings_difference_1)
      #print(loadings_difference_2) 
      #print(unique_loadings(Mab_jackknife_pca)[,1])
  if(loadings_difference_1 < loadings_difference_2){
    Mab_jackknife_pca$loadings <- -1*Mab_jackknife_pca$loadings
    Mab_jackknife_pca$scores <- -1*Mab_jackknife_pca$scores
    #print(unique_loadings(Mab_jackknife_pca)[,1])
      }

  
  #### TEST END
  
  
  Ma_procrusted_pca <- Ma_jackknife_pca
  Mab_procrusted_pca<-Mab_jackknife_pca


  
  Ta_jackknife <- design_sub_resampling %>%
    filter(subgroup!=i) %>% 
    cbind(Ma_procrusted_pca$scores[,1:2] %>% round(5)) %>%
    select(-c(subject,subgroup,treatment)) %>%
    distinct() %>%
    pivot_longer(cols=! timepoint,
                 names_to = "PC",
                 values_to = paste0("score_fold_",i)) %>%
    select(-c(timepoint,PC)) %>%
    cbind(Ta_jackknife,.)
   Tab_jackknife<-design_sub_resampling %>%
    filter(subgroup!=i) %>% 
    cbind(Mab_procrusted_pca$scores[,1:2] %>% round(5)) %>%
    select(-c(subject,subgroup)) %>%
    distinct() %>%
    pivot_longer(cols=! c(timepoint,treatment),
                 names_to = "PC",
                 values_to = paste0("score_fold_",i))%>%
    select(-c(timepoint,treatment,PC)) %>%
    cbind(Tab_jackknife,.)
  Pa_jackknife<-tibble(variable = LETTERS[1:n_variables]) %>%
    cbind(Ma_procrusted_pca$loadings[,1:2] %>% round(5)) %>%
    pivot_longer(cols=! variable,
                 names_to = "PC",
                 values_to = paste0("loading_fold_",i)) %>%
    select(-c(variable,PC))%>%
             cbind(Pa_jackknife,.)
  Pab_jackknife<-tibble(variable = LETTERS[1:n_variables]) %>%
    cbind(Mab_procrusted_pca$loadings[,1:2] %>% round(5)) %>%
    pivot_longer(cols=! variable,
                 names_to = "PC",
                 values_to = paste0("loading_fold_",i))%>%
    select(-c(variable,PC))%>%
             cbind(Pab_jackknife,.)
}
```


# Calculate 2.5th and 97th percentile
```{r}
# Scores
Ta_quantiles <- Ta_jackknife %>% pivot_longer(cols=!c(timepoint,PC),
                              names_to = "fold",
                              values_to = "score",
                              names_prefix = "score_fold_") %>%
  group_by(timepoint,PC) %>%
  mutate(quantile_025 = quantile(score,.025)%>% rep(n_folds),
         quantile_975 = quantile(score,.975)%>% rep(n_folds)) %>%
  select(timepoint,PC,quantile_025,quantile_975) %>% distinct() %>%
  ungroup()%>%
  mutate(est = Ta_est$score)
#
Tab_quantiles <- Tab_jackknife %>% pivot_longer(cols=!c(timepoint,PC,treatment),
                              names_to = "fold",
                              values_to = "score",
                              names_prefix = "score_fold_") %>%
  group_by(timepoint,treatment,PC) %>%
  mutate(quantile_025 = quantile(score,.025)%>% rep(n_folds),
         quantile_975 = quantile(score,.975)%>% rep(n_folds)) %>%
  select(timepoint,treatment,PC,quantile_025,quantile_975) %>% distinct()%>%
  ungroup()%>%
  mutate(est = Tab_est$score)

#Loadings
Pa_quantiles <- Pa_jackknife %>% pivot_longer(cols=!c(Variable,PC),
                              names_to = "fold",
                              values_to = "loading",
                              names_prefix = "loading_fold_") %>%
  group_by(Variable,PC)%>%
  mutate(quantile_025 = quantile(loading,.025)%>% rep(n_folds),
         quantile_975 = quantile(loading,.975)%>% rep(n_folds)) %>%
  select(Variable,PC,quantile_025,quantile_975) %>% distinct() %>%
  ungroup()%>%
  mutate(est=Pa_est$loading)
Pab_quantiles <-Pab_jackknife %>% pivot_longer(cols=!c(Variable,PC),
                              names_to = "fold",
                              values_to = "loading",
                              names_prefix = "loading_fold_") %>%
  group_by(Variable,PC)%>%
  mutate(quantile_025 = quantile(loading,.025)%>% rep(n_folds),
         quantile_975 = quantile(loading,.975)%>% rep(n_folds)) %>%
  select(Variable,PC,quantile_025,quantile_975) %>% distinct()%>%
  ungroup()%>%
  mutate(est=Pab_est$loading)
```

# Plot scores with expected values
```{r}
ggarrange(
Ta_quantiles %>%
  mutate(pc=PC,
         expl = rep(perc_expl_a[1:2],n_timepoints))%>%
  group_by(PC)%>%group_nest() %>%
  mutate(plot = map(data,function(x) x %>% 
                      mutate(timepoint = timepoints)%>%
                      ggplot(aes(x = timepoint,
                                 y = est,
                                 group=timepoint))+
                      geom_point()+
                      geom_errorbar(aes(ymin=quantile_025,
                                        ymax=quantile_975))+
                      theme_classic()+
    theme(aspect.ratio = 1)+
                      labs(x="Time (Months)",
                           y=paste0("Time effect\nScores PC",x$pc,"(",x$expl,"%)")))) %>%
  pull("plot") %>%
  ggarrange(plotlist=.),

Tab_quantiles %>%
  mutate(pc=PC,
         expl=rep(perc_expl_ab[1:2],n_treatments*n_timepoints))%>%
  group_by(PC)%>%group_nest() %>%
  mutate(plot = map(data,function(x) x %>%
                      mutate(treatment = factor(treatment),
                             timepoint = rep(timepoints,each=5))%>%
                      ggplot(aes(x = timepoint,
                                 y = est,
                                 color=treatment,
                                 group=factor(treatment)))+
                      geom_point(position=position_dodge(width=.4))+
                      geom_errorbar(aes(ymin=quantile_025,
                                        ymax=quantile_975),
                                    width=3,
                                    position = position_dodge(width=.4))+
                      theme_classic()+
    theme(aspect.ratio = 1)+
                      labs(x="Time (Months)",
                           y=paste0("Time:Treatment effect\nScores PC",x$pc,"(",x$expl,"%)"),
                           color="Treatment Group"))) %>%
  pull("plot") %>%
  ggarrange(plotlist=., common.legend = TRUE,legend="bottom"),nrow=2, common.legend=TRUE,legend="bottom")
```

# Loadings
```{r}
ggarrange(
Pa_quantiles%>%
  mutate(pc=PC,
         expl=rep(perc_expl_a[1:2],n_variables))%>%
  group_by(PC)%>%group_nest() %>%
  mutate(plot = map(data,function(x) x %>%
                      ggplot(aes(x = Variable,
                                 y = est,
                                 group=Variable))+
                      geom_bar(stat="identity")+
                      geom_errorbar(aes(ymin=quantile_025,
                                        ymax=quantile_975))+
                      theme_classic()+
                      labs(x="Variable",
                           y=paste0("Time effect\nLoadings PC",x$pc," (",x$expl,"%)"))+
                      theme(aspect.ratio = 1))) %>%
  pull("plot") %>%
  ggarrange(plotlist=.),

Pab_quantiles%>%
  mutate(pc = PC,
         expl=rep(perc_expl_ab[1:2],n_variables))%>%
  group_by(PC)%>%group_nest() %>%
  mutate(plot = map(data,function(x) x %>%
                      ggplot(aes(x = Variable,
                                 y = est,
                                 group=Variable))+
                      geom_bar(stat="identity")+
                      geom_errorbar(aes(ymin=quantile_025,
                                        ymax=quantile_975))+
                      theme_classic()+
                      labs(x="Variable",
                           y=paste0("Time:Treatment effect\nLoadings PC",x$pc," (",x$expl,"%)"))+
                      theme(aspect.ratio = 1))) %>%
  pull("plot") %>%
  ggarrange(plotlist=.),nrow=2, common.legend=TRUE,legend="bottom") 


```



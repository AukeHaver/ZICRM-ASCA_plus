---
title: "Zero-inflated GLMM ASCA Simulation"
author: "Auke Haver"
date: "15/05/2022"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
source("R/packages.R",local=TRUE)
source("R/simulation.R",local=TRUE)
source("R/analysis.R",local=TRUE)
source("R/plotting.R",local=TRUE)
ncores = detectCores()

outfile_prefix = format(Sys.Date(),"%Y%m%d")
```

# Introduction
In this simulation, we will apply the ASCA framework on unbalanced, zero-inflated, Poisson-distributed data. Furthermore, we will consider repeated measurements on unbalanced groups. This will require the use of Generalized Linear Mixed Models (GLMM) for estimating coefficients which can be used to construct effect matrices, which can be decomposed into scores and loadings through Singular Value Decomposition (SVD). We will utilize a 7-fold Jackknife approach for validation of our method.  

# Data Simulation
## Design
First, the parameters of the study need to be determined. Using the function gen_sim_info(), we simulate a design info file which constitutes a list with information on the design. Then, we construct a design matrix from the design info with sum-coded variables. Lastly, we construct a fixed effect model matrix for later multiplication with the fixed effect parameter matrix.
```{r Simulation Design}
timepoints = factor(c("0", "1", "2"))
treatments = factor(as.character(seq(5)))

design <- list(
  timepoints = factor(c("0", "1", "2")),
  treatments = factor(as.character(seq(5))),
  variables = LETTERS[1:16],
  n_subjects = 208,
  n_dummy_replicates = 60,
  family = "zinbinom",
  prob_zero = .75,
  sigma = 10,
  jackknife_folds = 7
  )

design$dummy_model_matrix = tibble(
  timepoint = rep(design$timepoints, each = 5),
  treatment = rep(design$treatments, times = 3)
  ) %>%
  mutate(
    observation = paste0("time", timepoint, "treat", treatment),
  `(intercept)` = 1,
  time1 =  c( 0,  0,  0,  0,  0,  1,  1,  1,  1,  1,  0,  0,  0,  0,  0), # Reference coded
  time2 =  c( 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  1,  1,  1,  1,  1), 
  treat2 = c(-1,  1,  0,  0,  0, -1,  1,  0,  0,  0, -1,  1,  0,  0,  0), # Sum coded
  treat3 = c(-1,  0,  1,  0,  0, -1,  0,  1,  0,  0, -1,  0,  1,  0,  0),
  treat4 = c(-1,  0,  0,  1,  0, -1,  0,  0,  1,  0, -1,  0,  0,  1,  0),
  treat5 = c(-1,  0,  0,  0,  1, -1,  0,  0,  0,  1, -1,  0,  0,  0,  1),
) %>%
  mutate(
    int12 = time1 * treat2,
    int13 = time1 * treat3,
    int14 = time1 * treat4,
    int15 = time1 * treat5,
    int22 = time2 * treat2,
    int23 = time2 * treat3,
    int24 = time2 * treat4,
    int25 = time2 * treat5,
  ) %>%
  select(
    -treat2,
    -treat3,
    -treat4,
    -treat5
  ) 

design$dummy_design_matrix <- tibble(
  # The subjects involved in the study
  subject = seq(length(design$treatments) * design$n_dummy_replicates) %>%
    rep(length(design$timepoints)),
  # The timepoint of measurement
  timepoint = rep(
    x = design$timepoints,
    each = length(design$treatments) * design$n_dummy_replicates
    ),
  # The treatment the subject was subjected to
  treatment = rep(
    rep(design$treatments, each=design$n_dummy_replicates),
    times = length(design$timepoints)
)
)%>%
  left_join(
    x = .,
    y = design$dummy_model_matrix,
    by = c("timepoint","treatment")) %>%
  select(
    -observation
  )

design$X_dummy <- 
design$dummy_design_matrix %>%
  select(
    -subject,
    -timepoint,
    -treatment
  ) %>% 
  as.matrix()
```

```{r Prepare directories}
output_dir <- paste0(
  "Results/Simulation_",
  Sys.Date(),
  "_",
  design$family,
  "_prob_zero-",
  design$prob_zero,
  "_sigma-",
  design$sigma,
  "/"
)
# Prepare output directory
for(dir in c("Result", output_dir)){
  while(!file.exists(dir)){
    dir.create(dir)
  }
}
```

## Scores and Loadings
Having decided the design of the simulation, we will continue with setting the scores ($T$) and loadings ($P$) for the time ($\alpha$) and time-treatment interaction ($\alpha\beta$) effects, in order to create effect matrices. The requirement for the scores and loadings are that the former must all be orthogonal and the latter must all be orthonormal.
```{r Simulate scores and loadings}
# SCORES
## Time Effect
Ta <- c( 2.00, 3.00) %>%  # PC 1
 # rep(each = (design_info$n_treatments-1)*design_info$n_dummy_replicates) %>% 
 matrix(ncol=1) 
colnames(Ta) <- "PC1"
## Time:Treatment Interaction Effect
Tab<-c(-1,  4,   0,  1,  2,   0,   0, -2,    # P 1
        0,-.5,-1.5,  2,  1,-0.5,-1.5,  1)%>% # PC 2
  #rep(each = design_info$n_dummy_replicates)%>% 
  matrix(ncol=2) 
colnames(Tab) <- c("PC1", "PC2")
# LOADINGS
# Time Effect
Pa <- matrix(unit_vector(
    c(-1,-1,-1, 2, 0, 0, 0, 0, 1, 1,-2, 1, 0, 0, 0, 0)),
    ncol = 1)
# Time:Treatment Interaction Effect
Pab <- cbind(
  unit_vector(
    c( 0, 0, 0, 0,-1, 1, 2, 1,-2,-1,-1, 1, 0, 0, 0, 0)),
  unit_vector(
    c( 0, 0, 0, 0,-2, 1,-1,-1,-1, 2, 1, 1, 0, 0, 0, 0)))

# Explained variance per component
expl_var_a <-  perform_pca(Ta %*% t(Pa))$singular_values %>% 
  expl_var_from_svd()
expl_var_ab<-  perform_pca(Tab %*% t(Pab))$singular_values %>% 
  expl_var_from_svd()
```

## Plot Scores and Loadings
We are going to create 2 plots with each 4 subplots. For the Time and Time-Treatment Interaction effect we will make a scoreplot and loadings plot for principal component 1 and 2. 
```{r}
plt_Ta_PC1_simulation <-  plot_simulated_time_scores(design$dummy_design_matrix, Ta, expl_var_a, 1, bquote("T"[A]))
plt_Tab_PC1_simulation <- plot_simulated_interaction_scores(design$dummy_design_matrix, Tab, expl_var_ab, 1, bquote("T"[AB]))
plt_Tab_PC2_simulation <- plot_simulated_interaction_scores(design$dummy_design_matrix, Tab, expl_var_ab, 2, bquote("T"[AB]))
plt_Pa_PC1_simulation <-  plot_simulated_loadings(Pa, expl_var_a, 1, bquote("P"[A]))
plt_Pab_PC1_simulation <- plot_simulated_loadings(Pab, expl_var_ab, 1, bquote("P"[AB]))
plt_Pab_PC2_simulation <- plot_simulated_loadings(Pab, expl_var_ab, 2, bquote("P"[AB]))

plt_combined_simulation <- ggarrange(
  plt_Ta_PC1_simulation,
  plt_Tab_PC1_simulation,
  plt_Tab_PC2_simulation,
  plt_Pa_PC1_simulation,
  plt_Pab_PC1_simulation,
  plt_Pab_PC2_simulation,
  ncol = 3,
  nrow = 2,
  common.legend = TRUE,
  legend = "bottom"
)
ggsave(filename = file.path(output_dir, "plt_combined_simulation.png"),plt_combined_simulation,width = 10,height = 6)
ggsave(filename = file.path(output_dir, "plt_Ta_PC1_simulation.png"),plt_Ta_PC1_simulation ,width = 4,height = 4)
ggsave(filename = file.path(output_dir, "plt_Tab_PC1_simulation.png"),plt_Tab_PC1_simulation ,width = 4,height = 4)
ggsave(filename = file.path(output_dir, "plt_Tab_PC2_simulation.png"),plt_Tab_PC2_simulation ,width = 4,height = 4)
ggsave(filename = file.path(output_dir, "plt_Pa_PC1_simulation.png"),plt_Pa_PC1_simulation ,width = 4,height = 4)
ggsave(filename = file.path(output_dir, "plt_Pab_PC1_simulation.png"),plt_Pab_PC1_simulation,width = 4,height = 4)
ggsave(filename = file.path(output_dir, "plt_Pab_PC2_simulation.png"),plt_Pab_PC2_simulation,width = 4,height = 4)
```


## Compose Matrices and unbalance dataset
Next, we will create balanced simulation matrices from the design info and the fixed effect components.
```{r Compose Matrices and Unbalance}
# Compose (Effect) Matrices
balanced_simulation_matrices <- compose_matrices(design,
                                                 function_seed=1,
                                                 mu=5,
                                                 scores_time = Ta,
                                                 scores_interaction = Tab,
                                                 loadings_time = Pa,
                                                 loadings_interaction = Pab,
                                                 subject_mu = 0,
                                                 subject_Sigma = .05)

# Sample from distribution with certain mean
balanced_response_matrix <- 
  generate_response_matrix(balanced_simulation_matrices$logYhat,
                           type=design$family,
                           prob_str_0 = design$prob_zero,
                           sigma = design$sigma) 

# Generate unbalance in dataset and merge into one list
unbalanced_simulation_matrices <- 
  gen_sim_sub_matrices(design,
                       function_seed=1,
                       balanced_response_matrix,
                       balanced_simulation_matrices)

# Modify Design list
design$X <- unbalanced_simulation_matrices$X
design$design <- unbalanced_simulation_matrices$design

# Write matrices to xlsx
write_xlsx(
  x = lapply(
    X = unbalanced_simulation_matrices,
    FUN = function(x) as_tibble(x,.name_repair = "minimal")
  ),
  path = paste0(
    "results/", outfile_prefix, "_matrices.xlsx"
  )
)
```

## Plot Zero-inflation per zOTU
```{r}
gen_long_response_df(unbalanced_simulation_matrices) %>%
  mutate(var=zOTU)%>%
  group_by(zOTU)%>%
  group_nest()%>%
  mutate(
    plot = mclapply(
      X = data,
      FUN = function(x) x %>%
        ggplot(aes(x=count))+
        geom_histogram(bins=15)+
        theme_classic(base_size = 14)+
        theme(axis.text.x = element_text(angle=45,
                                         hjust=1))+
        labs(x=element_blank(),
             y=element_blank()),
      mc.cores = ncores)) %>%
  pull("plot") %>%
  ggarrange(plotlist=.,
            ncol=4,
            nrow=4,
            labels="AUTO",
            label.x=.75)%>%
  annotate_figure(
    bottom = text_grob(
      "zOTU Count",
      size=20
    ),
    left = text_grob("Frequency (counts)",
                     size=20,
                     rot=90))
  ggsave(
    filename= file.path(output_dir, "plt_zero_inflation_per_zOTU.png"),
    width = 6,
    height= 6)
```



# Perform ZIGLMM fit on complete dataset
```{r GLMM ASCA with Jackknife}
# Fit GLMMs and Extract coefficients
glmm_fit_results <-left_join(
  x = gen_long_response_df(unbalanced_simulation_matrices),
  y = design$dummy_model_matrix,
  by = c("timepoint", "treatment")) %>%
  fit_glmm(
    long_response_df = .,
    dist_family = design$family,
    cores=ncores
  ) %>% 
  filter(!is.na(model)) %>%
  extr_glmm_coef(
    model_df = .,
    family = design$family,
    cores = ncores)
```

# Perfrom ZIGLMM with jackknife resampling
```{r}
# Perform 7-fold Jackknife
glmm_jackknife_models <- fit_jackknife_models(
  glmm_fit_results,
  design,
  cores = ncores)
glmm_jackknife_results <- process_jackknife_models(
  glmm_jackknife_models,
  design
)
```



# Plot Jackknife results
## Plot Time Effect
```{r}
plt_Ta_PC1_estimate <-  plot_estimate_time_scores(glmm_jackknife_results$Ta, glmm_jackknife_results$perc_a, 1, bquote("T"[A]))
plt_Tab_PC1_estimate <- plot_estimate_interaction_scores(glmm_jackknife_results$Tab, glmm_jackknife_results$perc_ab, 1, bquote("T"[AB]))
plt_Tab_PC2_estimate <-  plot_estimate_interaction_scores(glmm_jackknife_results$Tab, glmm_jackknife_results$perc_ab, 2, bquote("T"[AB]))
plt_Pa_PC1_estimate <-  plot_estimate_loadings(glmm_jackknife_results$Pa, glmm_jackknife_results$perc_a, 1, bquote("P"[A]))
plt_Pab_PC1_estimate <- plot_estimate_loadings(glmm_jackknife_results$Pab, glmm_jackknife_results$perc_ab, 1, bquote("P"[AB]))
plt_Pab_PC2_estimate <- plot_estimate_loadings(glmm_jackknife_results$Pab, glmm_jackknife_results$perc_ab, 2, bquote("P"[AB]))

plt_combined_estimate <- ggarrange(
  plt_Ta_PC1_estimate,
  plt_Tab_PC1_estimate,
  plt_Tab_PC2_estimate,
  plt_Pa_PC1_estimate,
  plt_Pab_PC1_estimate,
  plt_Pab_PC2_estimate,
  ncol = 3,
  nrow = 2,
  common.legend = TRUE,
  legend = "bottom"
)
ggsave(filename = file.path(output_dir, "plt_combined_estimate.png"),plt_combined_estimate,width = 10,height = 6)
ggsave(filename = file.path(output_dir, "plt_Ta_PC1_estimate.png"),plt_Ta_PC1_estimate ,width = 4,height = 4)
ggsave(filename = file.path(output_dir, "plt_Tab_PC1_estimate.png"),plt_Tab_PC1_estimate ,width = 4,height = 4)
ggsave(filename = file.path(output_dir, "plt_Tab_PC2_estimate.png"),plt_Tab_PC2_estimate ,width = 4,height = 4)
ggsave(filename = file.path(output_dir, "plt_Pa_PC1_estimate.png"),plt_Pa_PC1_estimate ,width = 4,height = 4)
ggsave(filename = file.path(output_dir, "plt_Pab_PC1_estimate.png"),plt_Pab_PC1_estimate,width = 4,height = 4)
ggsave(filename = file.path(output_dir, "plt_Pab_PC2_estimate.png"),plt_Pab_PC2_estimate,width = 4,height = 4)

```

# Save data to file
```{r}
spreadsheet_list <- list()
spreadsheet_list$Pa <- Pa %>% as_tibble()
spreadsheet_list$Ta <- Ta %>% as_tibble()
spreadsheet_list$Pab <- Pab %>% as_tibble()
spreadsheet_list$Tab <- Tab %>% as_tibble()
spreadsheet_list$X <- design$X %>% as_tibble()
spreadsheet_list$design_matrix <- design$design

writexl::write_xlsx(
  x = spreadsheet_list,
  path = file.path(output_dir, "simulation_settings.xlsx")
)
```

